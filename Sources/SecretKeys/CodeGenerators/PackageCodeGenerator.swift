// The MIT License (MIT)
//
// Copyright (c) 2022 Tomoya Hayakawa (github.com/simorgh3196).

import Foundation

enum PackageCodeGenerator {
    static func generateCode(projectName: String, config: Configuration) -> String {
        """
        // swift-tools-version: 5.7

        // DO NOT MODIFY
        // Automatically generated by SecretKeys (https://github.com/simorgh3196/SecretKeys)

        import PackageDescription

        let package = Package(
            name: "\(projectName)",
            platforms: [
                .macOS(.v11),
                .iOS(.v11),
            ],
            products: [
        \(generateProductsCode(config: config))
            ],
            targets: [
        \(generateTargetsCode(config: config))

                .target(name: "SecretValueDecoder", path: "Sources/SecretValueDecoder"),
            ]
        )
        """
    }

    private static func generateProductsCode(config: Configuration) -> String {
        config.targets
            .map { "        .library(name: \"\($0.name)\", targets: [\"\($0.name)\"])," }
            .joined(separator: "\n")
    }

    private static func generateTargetsCode(config: Configuration) -> String {
        let mainTargets = config.targets
            .map { "        .target(name: \"\($0.name)\", dependencies: [\"SecretValueDecoder\"])," }
            .joined(separator: "\n")

        let testTargets = config.withUnitTest
          ? "\n" + config.targets
            .map { "        .testTarget(name: \"\($0.name)Test\", dependencies: [\"\($0.name)\"])," }
            .joined(separator: "\n")
          : ""

        return mainTargets + testTargets
    }
}
