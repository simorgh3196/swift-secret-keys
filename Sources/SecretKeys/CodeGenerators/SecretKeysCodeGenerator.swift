// The MIT License (MIT)
//
// Copyright (c) 2022 Tomoya Hayakawa (github.com/simorgh3196).

import Foundation

enum SecretKeysCodeGenerator {
    static func generateCode(namespace: String,
                             secrets: [Secret],
                             salt: [UInt8],
                             encoder: SecretValueEncoder,
                             includeBase: Bool) -> String {
        """
        // DO NOT MODIFY
        // Automatically generated by SecretKeys (https://github.com/simorgh3196/swift-secret-keys)

        import Foundation
        \(includeBase ? generateBaseCode(namespace: namespace) : "")
        extension \(namespace) {
            private static let salt: [UInt8] = [
                \(convertBytesTo16RadixString(from: salt))
            ]
            \(secrets.map { generateSecretCode($0, salt: salt, encoder: encoder) }.joined(separator: "\n"))
        }

        """
    }

    private static func generateBaseCode(namespace: String) -> String {
        """

        public enum \(namespace) {
            static let decoder = SecretValueDecoder()
        }

        """
    }

    private static func generateSecretCode(_ secret: Secret, salt: [UInt8], encoder: SecretValueEncoder) -> String {
        """

            @inline(__always)
            public static let \(secret.key): \(secret.value.type) = {
                let encodedBytes: [UInt8] = [
                    \(convertBytesTo16RadixString(from: encoder.encode(value: secret.value, with: salt)))
                ]
                return try! Self.decoder.decode(bytes: encodedBytes, with: Self.salt)
            }()
        """
    }

    private static func convertBytesTo16RadixString(from bytes: [UInt8]) -> String {
        bytes.map { "0x" + String($0, radix: 16) }.joined(separator: ", ")
    }
}
